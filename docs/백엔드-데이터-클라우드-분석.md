# 백엔드/데이터/클라우드 분석

## 파이어베이스 구성
- 클라이언트 초기화: services/firebase.ts
- 리전: asia-northeast1
- 사용 서비스: Auth, Firestore, Functions, Analytics

## 파이어스토어 컬렉션 모델(요약)
- users/{uid}: profile, gameData, ap, kois, activeDeviceId
- sessions/{uid}: deviceId, lastActive, isOnline
- marketplace/listings/items/{listingId}: 장터 매물
- marketplace/listings/items/{listingId}/bids/{bidId}: 입찰
- transactions/{txId}: 거래 로그
- rateLimits/{function_date}: 함수 일일 호출 제한

## 보안 규칙 파일
- 대상 파일: `firestore.rules`
- users: 인증 사용자 읽기, 본인만 쓰기
- sessions: 본인만 쓰기, 읽기 차단(서버 전용)
- marketplace: 읽기/생성 허용, 수정/삭제는 함수 전용
- transactions: 본인 거래만 읽기 허용, 쓰기 차단

## 클라우드 함수 엔트리
- 대상 파일: `functions/src/index.ts`
트리거/Callable:
- onSessionCreate: 세션 생성/갱신 시 users.activeDeviceId 반영
- onBidCreate: 입찰 검증, AP 차감/환불, 매물 업데이트
- processExpiredAuctions: 만료 경매 스케줄 처리(1분 주기)
- onBuyNow: 즉시구매 트랜잭션
- rewardAdPoints: 광고 보상 지급(토큰 기본 검증)
- onCancelListing: 무입찰 활성 매물 취소
- resetGameData: 새 게임 초기화(일일 제한)

운영 보호:
- 전역 옵션: maxInstances=10, memory=256MiB, timeout=30s
- 함수별 일일 호출 제한: 기본 1000회

## 서비스 계층
- 인증: services/auth.ts
- 세션: services/session.ts
- 저장 동기화: services/sync.ts
- AP 포인트: services/points.ts
- 프로필: services/profile.ts
- 장터: services/marketplace.ts
- 로컬저장 유틸: services/localSave.ts
- 범용 Firestore 유틸: services/firestore.ts
