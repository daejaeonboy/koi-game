# 아키텍처

## 상위 구조
1. UI 레이어: App.tsx와 components/*
2. 게임 상태 레이어: hooks/useKoiPond.ts, hooks/useAchievements.ts
3. 도메인 로직: utils/genetics.ts, utils/GameEngine.ts, utils/achievements.ts
4. 인프라 레이어: services/* (Auth, Sync, Session, Marketplace, Points)
5. 백엔드: Firestore + Cloud Functions + Security Rules

## 주요 데이터 흐름
1. 앱 시작: index.tsx -> AuthProvider -> App
2. 인증: Google 로그인 후 services/auth.ts가 Firebase Auth 상태 제공
3. 초기 동기화: App.tsx에서 startSession + loadUserDataOnce 병렬 실행
4. 로컬 저장: SAVE_GAME_KEY에 주기 저장(5초)
5. 클라우드 저장: 로그인 시 saveGameToCloud 주기 저장(5초)
6. 실시간 반영: AP 잔액/세션 충돌/장터 목록 onSnapshot 구독

## 게임 엔진 구조
- components/Pond.tsx가 캔버스를 생성하고 GameEngine 인스턴스를 관리
- GameEngine 책임
  - 코이 엔티티 동기화/업데이트/렌더링
  - 먹이 엔티티 추적 및 섭취 이벤트 콜백
  - 장식/테마/수질/야간 상태 반영
  - 수면 이펙트(WaterEffects) 처리
- KoiRenderer 책임
  - 다중 세그먼트 기반 코이 체형 렌더
  - 히트테스트(정확 클릭 판정)

## 상태/모듈 경계
- types.ts: 오프라인/게임 중심 타입
- types/online.ts: Firestore/온라인 중심 타입
- services/firestore.ts: 범용 Firestore 유틸(일부 레거시 성격 포함)
- services/marketplace.ts: 현재 장터 클라이언트 API

## 주의 포인트
- App.tsx 단일 파일 비중이 큼(상태/핸들러/모달 통합)
- services/geminiService.ts는 현재 빈 파일
- index.html에 Tailwind CDN 스크립트가 중복 선언됨(2회)
