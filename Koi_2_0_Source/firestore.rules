rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 사용자 데이터: 인증된 사용자 읽기 가능(랭킹 조회용), 쓰기는 본인만
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 세션: 본인만 쓰기, 읽기는 서버만
    match /sessions/{userId} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow read: if false; // Cloud Functions만 접근
    }
    
    // 장터 목록: 인증된 사용자 읽기/생성 가능
    match /marketplace/listings/items/{listingId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.sellerId;
      allow update, delete: if false; // Cloud Functions만 처리

      // 입찰 서브컬렉션
      match /bids/{bidId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
                      && request.resource.data.bidderId == request.auth.uid;
        allow update, delete: if false;
      }
    }
    
    // (레거시) 구버전 입찰 경로는 비활성화
    
    // 거래 내역: 본인 것만 읽기 가능
    match /transactions/{transactionId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow write: if false; // Cloud Functions만 처리
    }
  }
}
